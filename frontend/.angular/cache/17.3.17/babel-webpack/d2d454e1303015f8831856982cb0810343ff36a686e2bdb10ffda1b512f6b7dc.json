{"ast":null,"code":"import { __decorate } from \"tslib\";\nimport { Component, ViewChild } from '@angular/core';\nlet AdminPrestamosComponent = class AdminPrestamosComponent {\n  authService;\n  adminService;\n  router;\n  prestamosTable;\n  prestamos = [];\n  loading = false;\n  filtroEstado = 'TODOS'; // TODOS, PRESTADO, MULTA, DEVUELTO\n  constructor(authService, adminService, router) {\n    this.authService = authService;\n    this.adminService = adminService;\n    this.router = router;\n  }\n  ngOnInit() {\n    if (!this.authService.isAdmin()) {\n      alert('❌ No tienes permisos para acceder a esta sección. Debes ser ADMIN.');\n      this.router.navigate(['/']);\n      return;\n    }\n    this.cargarPrestamos();\n  }\n  ngAfterViewInit() {\n    // DataTable se inicializará después de cargar los datos\n  }\n  cargarPrestamos() {\n    this.loading = true;\n    this.adminService.listarPrestamos().subscribe({\n      next: prestamos => {\n        this.prestamos = prestamos;\n        this.loading = false;\n        setTimeout(() => this.inicializarDataTable(), 100);\n      },\n      error: err => {\n        console.error('Error al cargar préstamos:', err);\n        this.loading = false;\n        if (err.status === 403) {\n          alert('❌ No tienes permisos para acceder a esta sección. Debes ser ADMIN.');\n        } else {\n          alert('Error al cargar préstamos: ' + (err?.error?.message || 'Error desconocido'));\n        }\n      }\n    });\n  }\n  inicializarDataTable() {\n    if (this.prestamosTable && this.prestamosTable.nativeElement) {\n      if ($.fn.DataTable.isDataTable(this.prestamosTable.nativeElement)) {\n        $(this.prestamosTable.nativeElement).DataTable().destroy();\n      }\n      $(this.prestamosTable.nativeElement).DataTable({\n        language: {\n          url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json'\n        },\n        pageLength: 10,\n        order: [[0, 'desc']],\n        // Ordenar por ID descendente (más recientes primero)\n        columnDefs: [{\n          orderable: false,\n          targets: [8]\n        } // Botones de acción no ordenables\n        ]\n      });\n    }\n  }\n  recibirLibro(prestamo) {\n    if (!confirm(`¿Confirmas que recibiste el libro \"${prestamo.libro.titulo}\" de ${prestamo.usuario.nombre} ${prestamo.usuario.apellido}?`)) {\n      return;\n    }\n    this.adminService.recibirLibro(prestamo.id).subscribe({\n      next: () => {\n        this.cargarPrestamos();\n        alert('✅ Libro recibido exitosamente');\n      },\n      error: err => {\n        alert(err?.error?.message || 'Error al recibir el libro');\n      }\n    });\n  }\n  actualizarMultas() {\n    if (!confirm('¿Deseas actualizar las multas de todos los préstamos vencidos? Esto calculará las multas de $5,000 por día de retraso.')) {\n      return;\n    }\n    this.adminService.actualizarMultas().subscribe({\n      next: response => {\n        this.cargarPrestamos();\n        alert('✅ ' + response.message);\n      },\n      error: err => {\n        alert(err?.error?.message || 'Error al actualizar multas');\n      }\n    });\n  }\n  pagarMulta(prestamo) {\n    if (!confirm(`¿Confirmas que ${prestamo.usuario.nombre} ${prestamo.usuario.apellido} pagó la multa de $${prestamo.valorMulta?.toLocaleString()}?`)) {\n      return;\n    }\n    this.adminService.pagarMulta(prestamo.id).subscribe({\n      next: () => {\n        this.cargarPrestamos();\n        alert('✅ Multa marcada como pagada exitosamente');\n      },\n      error: err => {\n        alert(err?.error?.message || 'Error al pagar la multa');\n      }\n    });\n  }\n  calcularDiasTranscurridos(fechaPrestamo) {\n    const fecha = new Date(fechaPrestamo);\n    const hoy = new Date();\n    const diffTime = Math.abs(hoy.getTime() - fecha.getTime());\n    return Math.floor(diffTime / (1000 * 60 * 60 * 24));\n  }\n  calcularDiasRestantes(fechaLimite) {\n    const fecha = new Date(fechaLimite);\n    const hoy = new Date();\n    const diffTime = fecha.getTime() - hoy.getTime();\n    return Math.ceil(diffTime / (1000 * 60 * 60 * 24));\n  }\n  estaVencido(fechaLimite) {\n    return this.calcularDiasRestantes(fechaLimite) < 0;\n  }\n  getEstadoBadgeClass(estado) {\n    switch (estado) {\n      case 'PRESTADO':\n        return 'bg-primary';\n      case 'MULTA':\n        return 'bg-danger';\n      case 'DEVUELTO':\n        return 'bg-success';\n      default:\n        return 'bg-secondary';\n    }\n  }\n  getEstadoTexto(estado) {\n    switch (estado) {\n      case 'PRESTADO':\n        return 'Prestado';\n      case 'MULTA':\n        return 'En Multa';\n      case 'DEVUELTO':\n        return 'Devuelto';\n      default:\n        return estado;\n    }\n  }\n  formatearFecha(fecha) {\n    if (!fecha) return 'N/A';\n    return new Date(fecha).toLocaleDateString('es-ES', {\n      year: 'numeric',\n      month: 'short',\n      day: 'numeric'\n    });\n  }\n  formatearMoneda(valor) {\n    if (!valor) return '$0';\n    return '$' + valor.toLocaleString('es-CO');\n  }\n  aplicarFiltro() {\n    // Reinicializar DataTable con los datos filtrados\n    setTimeout(() => this.inicializarDataTable(), 100);\n  }\n  filtrarPrestamos() {\n    if (this.filtroEstado === 'TODOS') {\n      return this.prestamos;\n    }\n    return this.prestamos.filter(p => p.estado === this.filtroEstado);\n  }\n  getTotalPrestamos() {\n    return this.prestamos.length;\n  }\n  getPrestadosCount() {\n    return this.prestamos.filter(p => p.estado === 'PRESTADO').length;\n  }\n  getMultasCount() {\n    return this.prestamos.filter(p => p.estado === 'MULTA').length;\n  }\n  getDevueltosCount() {\n    return this.prestamos.filter(p => p.estado === 'DEVUELTO').length;\n  }\n};\n__decorate([ViewChild('prestamosTable')], AdminPrestamosComponent.prototype, \"prestamosTable\", void 0);\nAdminPrestamosComponent = __decorate([Component({\n  selector: 'app-admin-prestamos',\n  templateUrl: './admin-prestamos.component.html',\n  styleUrls: ['./admin-prestamos.component.css']\n})], AdminPrestamosComponent);\nexport { AdminPrestamosComponent };","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}
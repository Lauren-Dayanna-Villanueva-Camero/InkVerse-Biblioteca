<div class="admin-container">
  <div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h1 class="page-title mb-2">
          üë• Gesti√≥n de Usuarios
        </h1>
        <p class="text-muted">Administra los usuarios del sistema</p>
      </div>
      <div>
        <button class="btn btn-success" (click)="abrirCrearUsuario()">
          ‚ûï Nuevo Usuario
        </button>
      </div>
    </div>

    <!-- Tabla de usuarios -->
    <div class="card shadow-sm">
      <div class="card-header bg-success text-white">
        <h5 class="mb-0">
          üë• Lista de Usuarios
        </h5>
      </div>
      <div class="card-body">
        <div *ngIf="loading" class="text-center py-5">
          <div class="spinner-border text-success" role="status">
            <span class="visually-hidden">Cargando...</span>
          </div>
        </div>

        <div *ngIf="!loading" class="table-responsive">
          <table id="usuariosTable" #usuariosTable class="table table-striped table-hover">
            <thead class="table-dark">
              <tr>
                <th>ID</th>
                <th>Username</th>
                <th>Nombre</th>
                <th>Apellido</th>
                <th>Email</th>
                <th>Rol</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let usuario of usuarios">
                <td>{{ usuario.id }}</td>
                <td><strong>{{ usuario.username }}</strong></td>
                <td>{{ usuario.nombre }}</td>
                <td>{{ usuario.apellido }}</td>
                <td>{{ usuario.email }}</td>
                <td>
                  <span class="badge" [ngClass]="usuario.rol === 'ADMIN' ? 'bg-danger' : 'bg-primary'">
                    {{ usuario.rol }}
                  </span>
                </td>
                <td>
                  <span class="badge" [ngClass]="usuario.bloqueado ? 'bg-danger' : 'bg-success'">
                    {{ usuario.bloqueado ? 'Bloqueado' : 'Activo' }}
                  </span>
                </td>
                <td>
                  <button
                    class="btn btn-sm btn-info me-1"
                    (click)="verUsuario(usuario)"
                    title="Ver detalles"
                  >
                    üëÅÔ∏è
                  </button>
                  <button
                    class="btn btn-sm btn-warning me-1"
                    (click)="abrirEditarUsuario(usuario)"
                    title="Editar"
                  >
                    ‚úèÔ∏è
                  </button>
                  <button
                    class="btn btn-sm"
                    [ngClass]="usuario.bloqueado ? 'btn-success' : 'btn-secondary'"
                    (click)="toggleBloqueado(usuario)"
                    [title]="usuario.bloqueado ? 'Desbloquear' : 'Bloquear'"
                  >
                    {{ usuario.bloqueado ? 'üîì' : 'üîí' }}
                  </button>
                  <button
                    class="btn btn-sm btn-danger ms-1"
                    (click)="eliminarUsuario(usuario)"
                    title="Eliminar"
                  >
                    üóëÔ∏è
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal para crear/editar usuario -->
<div class="modal fade" id="usuarioModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">
          {{ modoEdicion ? 'Editar Usuario' : 'Nuevo Usuario' }}
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" (click)="cerrarModal()"></button>
      </div>
      <div class="modal-body">
        <form [formGroup]="usuarioForm" (ngSubmit)="guardarUsuario()">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Username <span class="text-danger">*</span></label>
              <input
                type="text"
                class="form-control"
                formControlName="username"
                [class.is-invalid]="usuarioForm.get('username')?.invalid && usuarioForm.get('username')?.touched"
              />
              <div class="invalid-feedback">El username es requerido</div>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Email <span class="text-danger">*</span></label>
              <input
                type="email"
                class="form-control"
                formControlName="email"
                [class.is-invalid]="usuarioForm.get('email')?.invalid && usuarioForm.get('email')?.touched"
              />
              <div class="invalid-feedback">El email es requerido y debe ser v√°lido</div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Nombre <span class="text-danger">*</span></label>
              <input
                type="text"
                class="form-control"
                formControlName="nombre"
                [class.is-invalid]="usuarioForm.get('nombre')?.invalid && usuarioForm.get('nombre')?.touched"
              />
              <div class="invalid-feedback">El nombre es requerido</div>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Apellido <span class="text-danger">*</span></label>
              <input
                type="text"
                class="form-control"
                formControlName="apellido"
                [class.is-invalid]="usuarioForm.get('apellido')?.invalid && usuarioForm.get('apellido')?.touched"
              />
              <div class="invalid-feedback">El apellido es requerido</div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Contrase√±a <span class="text-danger" *ngIf="!modoEdicion">*</span></label>
              <input
                type="password"
                class="form-control"
                formControlName="password"
                [placeholder]="modoEdicion ? 'Dejar vac√≠o para no cambiar' : 'Contrase√±a'"
                [class.is-invalid]="usuarioForm.get('password')?.invalid && usuarioForm.get('password')?.touched"
              />
              <small class="text-muted" *ngIf="modoEdicion">Dejar vac√≠o si no deseas cambiar la contrase√±a</small>
              <div class="invalid-feedback" *ngIf="!modoEdicion">La contrase√±a es requerida</div>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Rol <span class="text-danger">*</span></label>
              <select class="form-select" formControlName="rol">
                <option value="USUARIO">USUARIO</option>
                <option value="ADMIN">ADMIN</option>
              </select>
            </div>
          </div>

          <div class="mb-3">
            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                formControlName="bloqueado"
                id="bloqueadoCheck"
              />
              <label class="form-check-label" for="bloqueadoCheck">
                Usuario bloqueado
              </label>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" (click)="cerrarModal()">
              Cancelar
            </button>
            <button type="submit" class="btn btn-success" [disabled]="usuarioForm.invalid">
              {{ modoEdicion ? 'Actualizar' : 'Crear' }} Usuario
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modal para ver detalles del usuario -->
<div class="modal fade" id="verUsuarioModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">
          üë• Detalles del Usuario
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" (click)="cerrarModalVer()"></button>
      </div>
      <div class="modal-body" *ngIf="usuarioParaVer">
        <div class="mb-3">
          <strong>ID:</strong>
          <p class="mb-0 text-muted">#{{ usuarioParaVer.id }}</p>
        </div>
        <div class="mb-3">
          <strong>Username:</strong>
          <p class="mb-0">{{ usuarioParaVer.username }}</p>
        </div>
        <div class="mb-3">
          <strong>Nombre:</strong>
          <p class="mb-0">{{ usuarioParaVer.nombre }} {{ usuarioParaVer.apellido }}</p>
        </div>
        <div class="mb-3">
          <strong>Email:</strong>
          <p class="mb-0">{{ usuarioParaVer.email }}</p>
        </div>
        <div class="mb-3">
          <strong>Rol:</strong>
          <p class="mb-0">
            <span class="badge" [ngClass]="usuarioParaVer.rol === 'ADMIN' ? 'bg-danger' : 'bg-primary'">
              {{ usuarioParaVer.rol }}
            </span>
          </p>
        </div>
        <div class="mb-3">
          <strong>Estado:</strong>
          <p class="mb-0">
            <span class="badge" [ngClass]="usuarioParaVer.bloqueado ? 'bg-danger' : 'bg-success'">
              {{ usuarioParaVer.bloqueado ? 'Bloqueado' : 'Activo' }}
            </span>
          </p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" (click)="cerrarModalVer()">
          Cerrar
        </button>
        <button type="button" class="btn btn-success" (click)="editarDesdeModalVer()" *ngIf="usuarioParaVer">
          ‚úèÔ∏è Editar Usuario
        </button>
      </div>
    </div>
  </div>
</div>




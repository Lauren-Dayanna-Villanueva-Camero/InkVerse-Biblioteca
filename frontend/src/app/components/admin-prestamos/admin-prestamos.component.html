<div class="admin-container">
  <div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h1 class="page-title mb-2">
          üìñ Gesti√≥n de Pr√©stamos
        </h1>
        <p class="text-muted">Administra los pr√©stamos de libros y multas</p>
      </div>
      <div>
        <button class="btn btn-warning me-2" (click)="actualizarMultas()">
          üîÑ Actualizar Multas
        </button>
      </div>
    </div>

    <!-- Filtros -->
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <div class="row align-items-center">
          <div class="col-md-3">
            <label class="form-label"><strong>Filtrar por Estado:</strong></label>
            <select class="form-select" [(ngModel)]="filtroEstado" (change)="aplicarFiltro()">
              <option value="TODOS">Todos</option>
              <option value="PRESTADO">Prestados</option>
              <option value="MULTA">En Multa</option>
              <option value="DEVUELTO">Devueltos</option>
            </select>
          </div>
          <div class="col-md-9">
            <div class="d-flex gap-2 flex-wrap">
              <span class="badge bg-primary">Total: {{ getTotalPrestamos() }}</span>
              <span class="badge bg-primary">Prestados: {{ getPrestadosCount() }}</span>
              <span class="badge bg-danger">En Multa: {{ getMultasCount() }}</span>
              <span class="badge bg-success">Devueltos: {{ getDevueltosCount() }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabla de pr√©stamos -->
    <div class="card shadow-sm">
      <div class="card-header bg-warning text-dark">
        <h5 class="mb-0">
          üìñ Lista de Pr√©stamos
        </h5>
      </div>
      <div class="card-body">
        <div *ngIf="loading" class="text-center py-5">
          <div class="spinner-border text-warning" role="status">
            <span class="visually-hidden">Cargando...</span>
          </div>
        </div>

        <div *ngIf="!loading && prestamos.length === 0" class="text-center py-5">
          <div class="alert alert-warning" role="alert">
            <h5 class="alert-heading">‚ö†Ô∏è No hay pr√©stamos registrados</h5>
            <p>No se encontraron pr√©stamos en el sistema.</p>
          </div>
        </div>

        <div *ngIf="!loading && prestamos.length > 0" class="table-responsive">
          <table id="prestamosTable" #prestamosTable class="table table-striped table-hover">
            <thead class="table-dark">
              <tr>
                <th>ID</th>
                <th>Usuario</th>
                <th>Libro</th>
                <th>Fecha Pr√©stamo</th>
                <th>Fecha L√≠mite</th>
                <th>D√≠as Transcurridos</th>
                <th>D√≠as Restantes</th>
                <th>Estado</th>
                <th>D√≠as Retraso</th>
                <th>Multa</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let prestamo of filtrarPrestamos()">
                <td>{{ prestamo.id }}</td>
                <td>
                  <strong>{{ prestamo.usuario.nombre }} {{ prestamo.usuario.apellido }}</strong><br>
                  <small class="text-muted">{{ '@' + prestamo.usuario.username }}</small>
                </td>
                <td>
                  <strong>{{ prestamo.libro.titulo }}</strong><br>
                  <small class="text-muted">{{ prestamo.libro.autor }}</small>
                </td>
                <td>{{ formatearFecha(prestamo.fechaPrestamo) }}</td>
                <td>
                  {{ formatearFecha(prestamo.fechaLimite) }}
                  <span class="badge bg-danger ms-1" *ngIf="estaVencidoYEnPrestamo(prestamo)">
                    Vencido
                  </span>
                </td>
                <td>
                  <span class="badge bg-info">
                    {{ calcularDiasTranscurridos(prestamo.fechaPrestamo) }} d√≠as
                  </span>
                </td>
                <td>
                  <span class="badge" [ngClass]="getDiasRestantesClass(prestamo.fechaLimite)">
                    {{ calcularDiasRestantes(prestamo.fechaLimite) }} d√≠as
                  </span>
                </td>
                <td>
                  <span class="badge" [ngClass]="getEstadoBadgeClass(prestamo.estado)">
                    {{ getEstadoTexto(prestamo.estado) }}
                  </span>
                </td>
                <td>
                  <span class="badge bg-danger" *ngIf="tieneDiasRetraso(prestamo)">
                    {{ prestamo.diasRetraso }} d√≠as
                  </span>
                  <span class="text-muted" *ngIf="!tieneDiasRetraso(prestamo)">-</span>
                </td>
                <td>
                  <strong class="text-danger" *ngIf="tieneMulta(prestamo)">
                    {{ formatearMoneda(prestamo.valorMulta) }}
                  </strong>
                  <span class="text-muted" *ngIf="!tieneMulta(prestamo)">-</span>
                </td>
                <td>
                  <button
                    class="btn btn-sm btn-success me-1"
                    (click)="recibirLibro(prestamo)"
                    title="Recibir libro"
                    *ngIf="prestamo.estado === 'PRESTADO'"
                  >
                    üì• Recibir
                  </button>
                  <button
                    class="btn btn-sm btn-primary"
                    (click)="pagarMulta(prestamo)"
                    title="Pagar multa"
                    *ngIf="prestamo.estado === 'MULTA' && tieneMulta(prestamo)"
                  >
                    üí∞ Pagar Multa
                  </button>
                  <span class="text-muted" *ngIf="prestamo.estado === 'DEVUELTO'">-</span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

